"use strict";var topicExplorerApp=angular.module("topicExplorerApp",[]);topicExplorerApp.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),topicExplorerApp.factory("constants",function(){return{IFRAME_API_URL:"//www.youtube.com/iframe_api",GOOGLE_APIS_CLIENT_URL:"https://apis.google.com/js/client.js?onload=",GOOGLE_APIS_CLIENT_CALLBACK:"onClientLoad",OAUTH2_CLIENT_ID:"269758065116.apps.googleusercontent.com",OAUTH2_SCOPES:"https://www.googleapis.com/auth/youtube",OAUTH2_REVOKE_URL:"https://accounts.google.com/o/oauth2/revoke?token=",API_KEY:"AIzaSyAe112w0RobjC1XtoO3Os3YI6cvMZm9oKk",FREEBASE_API_URL:"https://www.googleapis.com/freebase/v1/search",YOUTUBE_API_SERVICE:"youtube",YOUTUBE_API_VERSION:"v3",FREEBASE_API_MAX_RESULTS:30,FREEBASE_CACHE_MINUTES:1440,YOUTUBE_CACHE_MINUTES:1440,MIN_SCORE:60,MAX_SCORE:100,SCORE_NORMALIZATION_FACTOR:35,YOUTUBE_API_MAX_RESULTS:50,DEFAULT_PROFILE_THUMBNAIL:"https://s.ytimg.com/yts/img/no_videos_140-vfl5AhOQY.png",VIDEO_KIND:"youtube#video",CHANNEL_KIND:"youtube#channel",PLAYLIST_KIND:"youtube#playlist",YOUTUBE_VIDEO_PAGE_URL_PREFIX:"http://youtu.be/",YOUTUBE_CHANNEL_PAGE_URL_PREFIX:"http://youtube.com/channel/",YOUTUBE_PLAYLIST_PAGE_URL_PREFIX:"http://www.youtube.com/playlist?list=",DEFAULT_DISPLAY_NAME:"Stranger"}}),topicExplorerApp.factory("youtube",["constants",function(a){function b(a,b){return a+JSON.stringify(b)}return function(c){c.path=[a.YOUTUBE_API_SERVICE,a.YOUTUBE_API_VERSION,c.service].join("/");var d=b(c.service,c.params),e=lscache.get(d);if(c.method=="GET"&&e)setTimeout(function(){c.callback(e)},1);else{var f=c.callback;delete c.callback;var g=a.YOUTUBE_CACHE_MINUTES;"cacheTimeoutMinutes"in c&&(g=c.cacheTimeoutMinutes);var h=gapi.client.request(c);h.execute(function(a){c.method=="GET"&&a&&!("error"in a)&&lscache.set(d,a,g),f(a)})}}}]),"use strict",topicExplorerApp.controller("MainCtrl",["$scope","$rootScope","$http","$window","constants","youtube",function(a,b,c,d,e,f){function g(b){a.topicResults=b.result.map(function(a){var b=a.name;a.notable&&a.notable.name&&(b+=" ("+a.notable.name+")");var c=a.score;return c>e.MAX_SCORE&&(c=e.MAX_SCORE),c<e.MIN_SCORE&&(c=e.MIN_SCORE),{name:b,mid:a.mid,style:{"font-size":c+"%",opacity:c/100}}})}function h(a,b){b=b.replace(/^UC/,"UU");var c=a.offsetWidth,d=a.offsetHeight;new YT.Player(a,{width:c,height:d,playerVars:{listType:"playlist",list:b,autoplay:1,controls:2,modestbranding:1,rel:0,showInfo:0}})}function i(a,b){var c=a.offsetWidth,d=a.offsetHeight;new YT.Player(a,{videoId:b,width:c,height:d,playerVars:{autoplay:1,controls:2,modestbranding:1,rel:0,showInfo:0}})}a.topicSearch=function(b){a.channelResults=[],a.playlistResults=[],a.videoResults=[];var d=lscache.get(b);if(d)g(d);else{var f=c.jsonp(e.FREEBASE_API_URL,{params:{query:b,key:e.API_KEY,limit:e.FREEBASE_API_MAX_RESULTS,callback:"JSON_CALLBACK"}});f.success(function(a){a.status=="200 OK"&&(lscache.set(b,a,e.FREEBASE_CACHE_MINUTES),g(a))})}},a.topicClicked=function(b,c){a.channelResults=[],a.playlistResults=[],a.videoResults=[],f({method:"GET",service:"search",params:{topicId:b,part:"snippet",maxResults:e.YOUTUBE_API_MAX_RESULTS,q:a.searchTerm||c},callback:function(b){a.$apply(function(){var c=[],d=[],f=[];"items"in b&&angular.forEach(b.items,function(a){switch(a.id.kind){case e.VIDEO_KIND:c.push({title:a.snippet.title,thumbnailUrl:a.snippet.thumbnails.high.url,id:a.id.videoId,href:e.YOUTUBE_VIDEO_PAGE_URL_PREFIX+a.id.videoId});break;case e.CHANNEL_KIND:d.push({title:a.snippet.title,thumbnailUrl:a.snippet.thumbnails.high.url,id:a.id.channelId,href:e.YOUTUBE_CHANNEL_PAGE_URL_PREFIX+a.id.channelId});break;case e.PLAYLIST_KIND:f.push({title:a.snippet.title,thumbnailUrl:a.snippet.thumbnails.high.url,id:a.id.playlistId,href:e.YOUTUBE_PLAYLIST_PAGE_URL_PREFIX+a.id.playlistId})}}),a.channelResults=d,a.playlistResults=f,a.videoResults=c})}})},a.addToList=function(a,c,d){var g=b.channelId.replace(/^UC/,c);a.textContent="Adding...",a.disabled=!0,f({method:"POST",service:"playlistItems",params:{part:"snippet"},body:{snippet:{playlistId:g,resourceId:{kind:e.VIDEO_KIND,videoId:d}}},callback:function(b){"error"in b?a.textContent="Error":a.textContent="Added"}})},a.videoClicked=function(a,b){var f=a.parentElement;typeof YT!="undefined"&&typeof YT.Player!="undefined"?i(f,b):(d.onYouTubeIframeAPIReady=function(){i(f,b)},c.jsonp(e.IFRAME_API_URL))},a.listPlayerClicked=function(a,b){var f=a.parentElement;typeof YT!="undefined"&&typeof YT.Player!="undefined"?h(f,b):(d.onYouTubeIframeAPIReady=function(){h(f,b)},c.jsonp(e.IFRAME_API_URL))},a.subscribeClicked=function(a,c){a.textContent="Subscribing...",a.disabled=!0,f({method:"POST",service:"subscriptions",params:{part:"snippet"},body:{snippet:{channelId:b.channelId,resourceId:{kind:e.CHANNEL_KIND,channelId:c}}},callback:function(b){"error"in b?a.textContent="Error":a.textContent="Subscribed"}})}}]),"use strict",topicExplorerApp.controller("UserCtrl",["$scope","$rootScope","$http","$window","constants",function(a,b,c,d,e){function h(b){a.$apply(function(){b&&!b.error?a.template=g:a.template=f})}var f="views/logged-out.html",g="views/logged-in.html";a.template=f,d[e.GOOGLE_APIS_CLIENT_CALLBACK]=function(){gapi.client.setApiKey(e.API_KEY),setTimeout(function(){gapi.auth.authorize({client_id:e.OAUTH2_CLIENT_ID,scope:e.OAUTH2_SCOPES,immediate:!0},h)},1)},a.login=function(){gapi.auth.authorize({client_id:e.OAUTH2_CLIENT_ID,scope:e.OAUTH2_SCOPES,immediate:!1},h)},b.logout=function(){lscache.flush(),b.channelId=null,a.template=f,c.jsonp(e.OAUTH2_REVOKE_URL+gapi.auth.getToken().access_token)},c.jsonp(e.GOOGLE_APIS_CLIENT_URL+e.GOOGLE_APIS_CLIENT_CALLBACK)}]),"use strict",topicExplorerApp.controller("LoggedInCtrl",["$scope","$rootScope","$http","constants","youtube",function(a,b,c,d,e){function f(b){Array.isArray(b)||(b=[b]);var c=b.pop();e({method:"GET",service:"playlistItems",params:{part:"contentDetails",playlistId:c,maxResults:d.YOUTUBE_API_MAX_RESULTS},callback:function(c){"items"in c&&angular.forEach(c.items,function(b){a.videoIds.push(b.contentDetails.videoId)}),b.length>0?f(b):g()}})}function g(){var b=a.videoIds.slice(0,50);e({method:"GET",service:"videos",params:{part:"topicDetails",id:b.join(",")},callback:function(a){if("items"in a){var b={};angular.forEach(a.items,function(a){"topicDetails"in a&&angular.forEach(a.topicDetails.topicIds,function(a){a in b||(b[a]=0),b[a]++})});var c=[];angular.forEach(b,function(a,b){c.push({mid:b,score:a})}),h(c.slice(0,d.FREEBASE_API_MAX_RESULTS))}}})}function h(a){var b=a.pop();if(b){var e=lscache.get(b.mid);if(e)i(e,b.score),a.length>0?h(a):j();else{var f=c.jsonp(d.FREEBASE_API_URL,{params:{query:b.mid,key:d.API_KEY,limit:d.FREEBASE_API_MAX_RESULTS,callback:"JSON_CALLBACK"}});f.success(function(c){c.status=="200 OK"&&(lscache.set(b.mid,c,d.FREEBASE_CACHE_MINUTES),i(c,b.score)),a.length>0?h(a):j()})}}}function i(b,c){if(b.result.length>0){var e=b.result[0],f=e.name;e.notable&&e.notable.name&&(f+=" ("+e.notable.name+")");var g=c*d.SCORE_NORMALIZATION_FACTOR;g>d.MAX_SCORE&&(g=d.MAX_SCORE),g<d.MIN_SCORE&&(g=d.MIN_SCORE),a.personalizedTopics.push({name:f,mid:e.mid,score:c,style:{"font-size":g+"%",opacity:g/100}})}}function j(){var c=a.personalizedTopics.sort(function(a,b){return b.score-a.score});setTimeout(function(){b.$apply(function(){b.topicResults=c})},1)}a.thumbnailUrl=d.DEFAULT_PROFILE_THUMBNAIL,e({method:"GET",service:"channels",params:{mine:"",part:"id,snippet,contentDetails"},callback:function(c){a.$apply(function(){if("items"in c){var e=c.items[0];a.title=e.snippet.title.split(/\W/)[0]||d.DEFAULT_DISPLAY_NAME,a.thumbnailUrl=e.snippet.thumbnails.default.url,b.channelId=e.id;var g=e.contentDetails.relatedPlaylists.uploads,h=g.replace(/^UU/,"FL"),i=g.replace(/^UU/,"LL"),j=g.replace(/^UU/,"WL");a.videoIds=[],a.personalizedTopics=[],f([j,h,i])}else a.title=d.DEFAULT_DISPLAY_NAME})}})}]);