<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
 <ModulePrefs title="Blogger Gadget"
              author="Eric Bidelman api.eric@google.com"
              height="380">
  <Require feature="opensocial-0.8" /> 
  <OAuth>
    <Service name="google">
      <Access url="https://www.google.com/accounts/OAuthGetAccessToken" method="GET" /> 
      <Request url="https://www.google.com/accounts/OAuthGetRequestToken?scope=http://www.blogger.com/feeds/" method="GET" /> 
      <Authorization url="https://www.google.com/accounts/OAuthAuthorizeToken?oauth_callback=http://gdata-samples.googlecode.com/svn/trunk/gadgets/blogger/authorized.html" /> 
    </Service>
  </OAuth>
  </ModulePrefs>
  <Content type="html">
  <![CDATA[ 
  
    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
    <html>
      <head>
      <base href="http://gdata-samples.googlecode.com/svn/trunk/gadgets/blogger/"/>
      <link href="blogger_gadget.css" type="text/css" rel="stylesheet"/> 
      <script src="http://monsur.nyc.corp.google.com:3223/jsapi"></script>
      <script type="text/javascript" src="http://jquery.com/src/jquery-latest.js"></script>
      <script type="text/javascript" src="tinymce/tiny_mce.js"></script>
      <script type="text/javascript">
        var BLOGGER_NS = 'http://www.blogger.com/atom/ns#';
        var bloggerService = null;
        
        function loadGdata() {
          google.load('gdata', '1.x');
          gadgets.util.registerOnLoadHandler(initGadget);
        }
        
        function initGadget() {
          tinyMCE.init({
            mode : 'textareas',
            theme : 'simple'
          });

          google.setOnLoadCallback(
            function () {
              bloggerService = new google.gdata.blogger.BloggerService('google-BloggerGadget-v1.0');
              bloggerService.useOAuth('google');
              fetchData();
            }
          );
        }
        
        function showOnly(id) {
          var sections = ['main', 'approval', 'waiting', 'loading'];
          for (var i = 0, section; section = sections[i]; ++i) {
            document.getElementById(section).style.display = section === id ? 'block' : 'none';
          }
        }
        
        function fetchData() {
          jQuery('#errors').hide();
          
          var callback = function(response) {
            if (response.oauthApprovalUrl) {
              jQuery('#personalize').get(0).href = response.oauthApprovalUrl;
              showOnly('approval');
            } else if (response.feed) {
              showResults(response);
              showOnly('main');
            } else {
              jQuery('#errors').html('Something went wrong');
              jQuery('#errors').fadeIn();
            }
          };
          
          var feedUri = 'http://www.blogger.com/feeds/default/blogs';
          bloggerService.getBlogFeed(feedUri, callback, callback);
        }
        
        function showResults(feedRoot) {                          
          var blogs = feedRoot.feed.getEntries();
          
          // Has the user created any blogs?
          if(!blogs.length) {
            jQuery('#main').html('First <a href="http://www.blogger.com" target="newblog">create a blog</a>.');
            return;
          }
            
          var html = [];
          for (var i = 0, blog; blog = blogs[i]; ++i) {
            var title = blog.getTitle().getText();
            var postsFeedUri = blog.getEntryPostLink().getHref();           
            html.push('<option value="' + postsFeedUri + '">' + title + '</option>');
          }
          
          jQuery('#postFeedUri').html(html.join('')).removeAttr('disabled'); 
        }
        
        function savePost(form) { 
          jQuery('#messages').fadeOut();
          jQuery('#submitButton').val('Publishing...').attr('disabled', 'disabled');
          
          var input = form.categories.value;
          var categories = jQuery.trim(input) != '' ? input.split(',') : [];   
          jQuery.each(categories, function(i, value) {
            var label = jQuery.trim(value);
            categories[i] = {scheme: BLOGGER_NS, term: label};
          });
          
          // update content textarea with rich text editors innerHTML
          tinyMCE.triggerSave();

          var newEntry = new google.gdata.blogger.BlogPostEntry({
              title: {
                type: 'text', 
                text: form.title.value
              },
              content: {
                type: 'text', 
                text: form.content.value
              },
              categories: categories
          });
          
          // publish as draft?
          var isDraft = form.draft.checked;
          if (isDraft) {
            newEntry.setControl({draft: {value: google.gdata.Draft.VALUE_YES}});
          }
          
          var handleInsert = function(entryRoot) {
            var entry = entryRoot.entry;
            
            var str = '';
            if (isDraft) {
              str = '(as draft)';
            } else {
              str = '<a href="' + entry.getHtmlLink().getHref() + '" target="_blankt">View it</a>';
            }

            jQuery('#messages').html('Post published! ' + str).fadeIn();
            jQuery('#submitButton').val('Save').removeAttr('disabled');
          };
          
          bloggerService.insertEntry(form.postFeedUri.value, newEntry, handleInsert, handleError);
        }
        
        function handleError(e) {
          var msg = e.cause ? e.cause.statusText + ': ' : '';
          msg += e.message;
          alert('Error: ' + msg);
        }
        
        loadGdata();
        
      </script>
      </head>
      <body>      
        <div id="errors" style="display: none"></div>
       
        <div id="main" style="display:none">
         <form id="postForm" name="postForm" onsubmit="savePost(this); return false;">
           <div id="messages" style="display: none"></div>
           <div class="selectFeed">Publish to: <select id="postFeedUri" name="postFeedUri" disabled="disabled"><option>loading blog list...</option></select></div>
           <h4 style="clear:both">Title</h4>
           <input type="text" id="title" name="title"/>
           <h4>Body</h4>
           <textarea id="content" name="content" cols="100" rows="200"></textarea>
           <h4 style="float:left;">Labels (comma separated)</h4><img src="blogger.png" style="float:right"/>
           <input type="text" id="categories" name="categories"/>
           <p><input type="submit" id="submitButton" value="Save"/> <input type="checkbox" id="draft" name="draft" checked="checked"/> <label for="draft">Draft?</label></p>
          </form>
        </div>
        
        <div id="loading">
          <h3>Loading...</h3>
          <p><img src="ajax-loader.gif"></p>
        </div>
    
        <div id="approval" style="display: none">
          <a id="personalize" onclick="javascript:showOnly('waiting'); return true" target="approve">Sign in to Blogger</a>
        </div>
    
        <div id="waiting" style="display: none">
          <a onclick="javascript:fetchData()">I've approved access</a>
        </div>
      </body>
    </html>
  ]]> 
  </Content>
  </Module>